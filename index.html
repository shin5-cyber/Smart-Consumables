<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Supplies Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; }
        /* カスタムスクロールバー */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        
        .category-chip.active {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-1px);
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-20">

    <!-- ヘッダー -->
    <header class="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i class="fas fa-boxes"></i> SSM
            </h1>
            <div class="flex gap-3">
                <button onclick="openDataModal()" class="text-sm bg-indigo-500 hover:bg-indigo-400 px-3 py-1 rounded transition">
                    <i class="fas fa-sync-alt"></i> データ共有
                </button>
                <button onclick="openSettingsModal()" class="text-sm bg-indigo-500 hover:bg-indigo-400 px-3 py-1 rounded transition">
                    <i class="fas fa-cog"></i> 設定
                </button>
            </div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto p-4 space-y-6">

        <!-- アラートセンター -->
        <div id="alertSection" class="hidden space-y-2">
            <!-- JSでアラートを注入 -->
        </div>

        <!-- コントロールパネル -->
        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
            <!-- カテゴリフィルター -->
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-2">カテゴリ</label>
                <div id="categoryFilters" class="flex flex-wrap gap-2">
                    <!-- JSで生成 -->
                </div>
            </div>

            <!-- ソート・追加ボタン -->
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4 border-t border-slate-100 pt-4">
                <div class="flex gap-2 items-center w-full sm:w-auto text-sm">
                    <span class="text-slate-500 whitespace-nowrap"><i class="fas fa-sort"></i> 並替:</span>
                    <select id="sortPrimary" class="bg-slate-100 border-none rounded px-2 py-1 text-slate-700 focus:ring-2 focus:ring-indigo-300">
                        <option value="none">指定なし</option>
                        <option value="expiry">期限が近い順</option>
                        <option value="stock">在庫が少ない順</option>
                    </select>
                </div>
                <button onclick="openItemModal()" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold shadow-md transition transform hover:scale-105 flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> 在庫を追加
                </button>
            </div>
        </div>

        <!-- 在庫リスト -->
        <div id="inventoryList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- JSでアイテムカードを生成 -->
        </div>
    </div>

    <!-- アイテム追加・編集モーダル -->
    <div id="itemModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden my-8">
            <div class="bg-indigo-600 p-4 flex justify-between items-center text-white">
                <h2 id="modalTitle" class="font-bold text-lg">在庫登録</h2>
                <button onclick="closeItemModal()" class="hover:text-indigo-200"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 space-y-4 max-h-[80vh] overflow-y-auto">
                <input type="hidden" id="itemId">
                
                <!-- 基本情報 -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">商品名 <span class="text-red-500">*</span></label>
                        <input type="text" id="itemName" list="nameSuggestions" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="例: 牛乳">
                        <datalist id="nameSuggestions"></datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">カテゴリ <span class="text-red-500">*</span></label>
                        <select id="itemCategory" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none"></select>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-1">
                        <label class="block text-sm font-medium text-slate-700 mb-1">個数 <span class="text-red-500">*</span></label>
                        <input type="number" id="itemQuantity" min="0" step="0.25" value="1" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-slate-700 mb-1">消費期限</label>
                        <input type="date" id="itemExpiry" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">開封日 (任意)</label>
                    <input type="date" id="itemOpenDate" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>

                <!-- 詳細設定アコーディオン -->
                <details class="group bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <summary class="flex justify-between items-center font-medium cursor-pointer list-none text-indigo-600 text-sm">
                        <span><i class="fas fa-sliders-h mr-2"></i>通知・動作設定</span>
                        <span class="transition group-open:rotate-180"><i class="fas fa-chevron-down"></i></span>
                    </summary>
                    <div class="text-slate-600 mt-4 space-y-4 text-sm">
                        
                        <!-- 在庫切れ時の動作 -->
                        <div>
                            <label class="block font-medium mb-1">在庫が0になった時</label>
                            <div class="flex gap-4">
                                <label class="flex items-center"><input type="radio" name="zeroAction" value="keep" checked class="mr-2 text-indigo-600"> リストに残す(通知)</label>
                                <label class="flex items-center"><input type="radio" name="zeroAction" value="delete" class="mr-2 text-indigo-600"> 削除する</label>
                            </div>
                        </div>

                        <!-- 在庫僅少アラート -->
                        <div class="border-t border-slate-200 pt-3">
                            <label class="flex items-center mb-2 font-medium cursor-pointer">
                                <input type="checkbox" id="lowStockNotify" class="mr-2 rounded text-indigo-600 focus:ring-indigo-500">
                                在庫が減ったら通知する
                            </label>
                            <div id="lowStockConfig" class="pl-6 hidden">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs">残り</span>
                                    <input type="number" id="lowStockThreshold" value="1" min="0.25" step="0.25" class="w-20 p-1 border rounded text-center">
                                    <span class="text-xs">個以下で通知</span>
                                </div>
                            </div>
                        </div>

                        <!-- 交換時期アラート -->
                        <div class="border-t border-slate-200 pt-3">
                            <label class="flex items-center mb-2 font-medium cursor-pointer">
                                <input type="checkbox" id="replacementNotify" class="mr-2 rounded text-indigo-600 focus:ring-indigo-500">
                                開封後に交換時期を通知
                            </label>
                            <div id="replacementConfig" class="pl-6 hidden space-y-2">
                                <div class="flex items-center gap-2">
                                    <input type="number" id="replacementValue" value="1" min="1" class="w-16 p-1 border rounded text-center">
                                    <select id="replacementUnit" class="p-1 border rounded bg-white">
                                        <option value="days">日後</option>
                                        <option value="weeks">週間後</option>
                                        <option value="months">ヶ月後</option>
                                    </select>
                                    <span class="text-xs">に通知</span>
                                </div>
                                <p class="text-xs text-slate-400">※ 日:5日前, 週:1週間前, 月:1ヶ月前にアラート表示</p>
                            </div>
                        </div>
                    </div>
                </details>

                <button onclick="saveItem()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-md transition">
                    保存する
                </button>
            </div>
        </div>
    </div>

    <!-- 設定モーダル（カテゴリ管理） -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
                <h2 class="font-bold">カテゴリ管理</h2>
                <button onclick="closeSettingsModal()" class="hover:text-slate-300"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4">
                <div class="flex gap-2 mb-4">
                    <input type="text" id="newCategoryName" class="flex-1 p-2 border rounded focus:ring-2 focus:ring-slate-500 outline-none" placeholder="新しいカテゴリ名">
                    <button onclick="addCategory()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 rounded transition">追加</button>
                </div>
                <div class="max-h-60 overflow-y-auto">
                    <ul id="categoryListSettings" class="space-y-2">
                        <!-- JSでリスト生成 -->
                    </ul>
                </div>
                <p class="text-xs text-slate-400 mt-2 text-right">※最大50個まで</p>
            </div>
        </div>
    </div>

        <div id="dataModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden">
            <div class="bg-indigo-600 p-4 text-white flex justify-between items-center">
                <h2 class="font-bold flex items-center gap-2"><i class="fas fa-scroll"></i> 管理情報の共有</h2>
                <button onclick="closeDataModal()" class="hover:text-indigo-200"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <h3 class="font-bold text-sm text-slate-700 mb-2">現在の情報を書き出す</h3>
                    <div class="flex gap-2">
                        <input type="text" id="exportString" readonly class="flex-1 bg-slate-100 p-2 text-xs font-mono border rounded" placeholder="ここに呪文が表示されます">
                        <button onclick="copyExportString()" class="bg-indigo-100 text-indigo-700 px-3 rounded hover:bg-indigo-200 transition whitespace-nowrap" title="コピー"><i class="fas fa-copy"></i></button>
                        <button onclick="shareData()" class="bg-green-100 text-green-700 px-3 rounded hover:bg-green-200 transition whitespace-nowrap" title="シェア"><i class="fas fa-share-alt"></i></button>
                    </div>
                </div>
                <div class="border-t pt-4">
                    <h3 class="font-bold text-sm text-slate-700 mb-2">情報を読み込む（上書きされます）</h3>
                    <textarea id="importString" class="w-full p-2 border rounded text-xs font-mono h-20 mb-2 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="復活の呪文を入力してください"></textarea>
                    <button onclick="importData()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded font-bold transition">
                        インポートして更新
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- データ構造と初期化 ---
        const DEFAULT_CATEGORIES = ['食材', '日常品', '調味料'];
        const STORAGE_KEY = 'ssm_app_data';

        let appData = {
            categories: [...DEFAULT_CATEGORIES],
            items: []
        };

        // --- カテゴリごとの色定義（簡易ハッシュ）---
        const CATEGORY_COLORS = {
            '食材': 'bg-blue-100 text-blue-800 border-blue-200',
            '日常品': 'bg-purple-100 text-purple-800 border-purple-200',
            '調味料': 'bg-amber-100 text-amber-800 border-amber-200'
        };
        const DEFAULT_COLOR = 'bg-slate-100 text-slate-800 border-slate-200';

        let currentFilter = 'all';

        // --- 初期化処理 ---
        function init() {
            loadData();
            renderCategories();
            renderItems();
            updateFormVisibility();
            
            // イベントリスナー設定
            document.getElementById('sortPrimary').addEventListener('change', renderItems);
            
            // チェックボックス連動
            document.getElementById('lowStockNotify').addEventListener('change', updateFormVisibility);
            document.getElementById('replacementNotify').addEventListener('change', updateFormVisibility);
        }

        function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    appData.categories = parsed.categories || [...DEFAULT_CATEGORIES];
                    appData.items = parsed.items || [];
                } catch (e) {
                    console.error('データ読み込みエラー', e);
                }
            }
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
            renderItems(); // アラート再計算などのため
        }

        // --- ロジック系関数 ---

        function getCategoryColorClass(cat) {
            return CATEGORY_COLORS[cat] || DEFAULT_COLOR;
        }

        // アラート判定
        function getAlerts(item) {
            const alerts = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // 1. 在庫0のアラート
            if (item.quantity === 0 && item.zeroAction === 'keep') {
                alerts.push({ type: 'danger', msg: '在庫切れ' });
            }

            // 2. 在庫僅少
            if (item.lowStockNotify && item.quantity > 0 && item.quantity <= item.lowStockThreshold) {
                alerts.push({ type: 'warning', msg: '残りわずか' });
            }

            // 3. 消費期限 (3日前)
            if (item.expiryDate) {
                const expiry = new Date(item.expiryDate);
                const diffTime = expiry - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                if (diffDays < 0) {
                    alerts.push({ type: 'danger', msg: '期限切れ' });
                } else if (diffDays <= 3) {
                    alerts.push({ type: 'warning', msg: `期限あと${diffDays}日` });
                }
            }

            // 4. 交換時期
            if (item.replacementNotify && item.openDate) {
                const openDate = new Date(item.openDate);
                let targetDate = new Date(openDate);
                let alertThresholdDays = 0;

                if (item.replacementUnit === 'days') {
                    targetDate.setDate(openDate.getDate() + parseInt(item.replacementValue));
                    alertThresholdDays = 5;
                } else if (item.replacementUnit === 'weeks') {
                    targetDate.setDate(openDate.getDate() + (parseInt(item.replacementValue) * 7));
                    alertThresholdDays = 7;
                } else if (item.replacementUnit === 'months') {
                    targetDate.setMonth(openDate.getMonth() + parseInt(item.replacementValue));
                    alertThresholdDays = 30; // 1ヶ月前
                }

                const diffTime = targetDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays <= alertThresholdDays) {
                    const msg = diffDays < 0 ? '交換推奨(経過)' : 'もうすぐ交換';
                    alerts.push({ type: 'info', msg: msg });
                }
            }

            return alerts;
        }

        // --- 表示系関数 ---

        function renderCategories() {
            const container = document.getElementById('categoryFilters');
            const select = document.getElementById('itemCategory');
            const listSettings = document.getElementById('categoryListSettings');

            // フィルタ用HTML
            let filterHtml = `<button onclick="setFilter('all')" class="category-chip px-4 py-1.5 rounded-full text-sm font-bold transition border ${currentFilter === 'all' ? 'bg-slate-800 text-white border-slate-800 active' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}">すべて</button>`;
            
            // セレクトボックス用HTML
            let selectHtml = `<option value="" disabled selected>選択してください</option>`;
            
            // 設定リスト用HTML
            let settingsHtml = '';

            appData.categories.forEach(cat => {
                const isActive = currentFilter === cat;
                const activeClass = isActive ? 'ring-2 ring-indigo-500 ring-offset-1' : '';
                const colorClass = getCategoryColorClass(cat);
                
                // フィルタ
                filterHtml += `<button onclick="setFilter('${cat}')" class="category-chip px-3 py-1.5 rounded-full text-sm font-medium transition border ${activeClass} ${colorClass} bg-opacity-50 hover:bg-opacity-100">${cat}</button>`;
                
                // セレクト
                selectHtml += `<option value="${cat}">${cat}</option>`;

                // 設定リスト
                settingsHtml += `
                    <li class="flex justify-between items-center bg-slate-50 p-2 rounded border">
                        <span>${cat}</span>
                        ${DEFAULT_CATEGORIES.includes(cat) ? '<span class="text-xs text-slate-400">固定</span>' : `<button onclick="deleteCategory('${cat}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>`}
                    </li>
                `;
            });

            container.innerHTML = filterHtml;
            select.innerHTML = selectHtml;
            listSettings.innerHTML = settingsHtml;
        }

        function setFilter(cat) {
            currentFilter = cat;
            renderCategories(); // スタイル更新のため
            renderItems();
        }

        function renderItems() {
            const listContainer = document.getElementById('inventoryList');
            const alertContainer = document.getElementById('alertSection');
            const sortMode = document.getElementById('sortPrimary').value;

            // フィルタリング
            let filtered = appData.items.filter(item => currentFilter === 'all' || item.category === currentFilter);

            // ソート
            filtered.sort((a, b) => {
                // 条件1: 期限 (昇順: 早いほうが上)
                if (sortMode === 'expiry') {
                    const dateA = a.expiryDate ? new Date(a.expiryDate).getTime() : 9999999999999;
                    const dateB = b.expiryDate ? new Date(b.expiryDate).getTime() : 9999999999999;
                    if (dateA !== dateB) return dateA - dateB;
                }
                // 条件2: 在庫数 (昇順: 少ないほうが上)
                if (sortMode === 'stock') {
                    if (a.quantity !== b.quantity) return a.quantity - b.quantity;
                }
                
                // デフォルト: 名前順など
                return 0;
            });
            // ソート条件が競合した場合（UI上で複数指定はできない仕様だが、ロジックとして）
            // 上記if文構造で、sortModeの指定が優先され、次に進まない。
            // 複合ソートが必要な場合:
            if (sortMode === 'expiry') {
                // 日付が同じなら在庫順にするなどのサブソート
                 filtered.sort((a, b) => {
                    const dateA = a.expiryDate ? new Date(a.expiryDate).getTime() : 9999999999999;
                    const dateB = b.expiryDate ? new Date(b.expiryDate).getTime() : 9999999999999;
                    if (dateA !== dateB) return dateA - dateB;
                    return a.quantity - b.quantity; // サブ条件
                });
            }


            listContainer.innerHTML = '';
            alertContainer.innerHTML = '';
            alertContainer.classList.add('hidden');

            const allAlerts = [];

            if (filtered.length === 0) {
                listContainer.innerHTML = `<div class="col-span-1 md:col-span-2 text-center py-10 text-slate-400">アイテムがありません</div>`;
                return;
            }

            filtered.forEach(item => {
                const alerts = getAlerts(item);
                if (alerts.length > 0) {
                    alerts.forEach(a => {
                        allAlerts.push({ item: item, ...a });
                    });
                }

                const colorClass = getCategoryColorClass(item.category);
                
                // カードHTML生成
                const card = document.createElement('div');
                card.className = "bg-white rounded-xl shadow border border-slate-100 p-4 animate-fade-in relative overflow-hidden group";
                
                // アラートバッジ（カード内）
                let badges = '';
                alerts.forEach(a => {
                    let badgeColor = 'bg-gray-500';
                    if (a.type === 'danger') badgeColor = 'bg-red-500';
                    if (a.type === 'warning') badgeColor = 'bg-amber-500';
                    if (a.type === 'info') badgeColor = 'bg-sky-500';
                    badges += `<span class="${badgeColor} text-white text-[10px] px-2 py-0.5 rounded-full mr-1">${a.msg}</span>`;
                });

                // カードの内容
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="inline-block text-xs px-2 py-0.5 rounded border mb-1 ${colorClass}">${item.category}</span>
                            <h3 class="font-bold text-lg text-slate-800 leading-tight">${item.name}</h3>
                            <div class="flex flex-wrap mt-1">${badges}</div>
                        </div>
                        <button onclick="editItem('${item.id}')" class="text-slate-300 hover:text-indigo-500 p-1"><i class="fas fa-edit"></i></button>
                    </div>
                    
                    <div class="text-sm text-slate-500 space-y-1 mb-4">
                        <div class="flex items-center gap-2">
                            <i class="far fa-clock w-4 text-center"></i> 期限: ${item.expiryDate ? item.expiryDate : '--'}
                        </div>
                        ${item.openDate ? `<div class="flex items-center gap-2"><i class="far fa-folder-open w-4 text-center"></i> 開封: ${item.openDate}</div>` : ''}
                    </div>

                    <div class="mt-auto bg-slate-50 p-3 rounded-lg">
                        <div class="flex justify-between items-baseline mb-2">
                            <span class="text-xs font-bold text-slate-400">在庫数</span>
                            <span class="text-2xl font-bold ${item.quantity === 0 ? 'text-red-500' : 'text-slate-700'}">${item.quantity}</span>
                        </div>
                        <div class="grid grid-cols-3 gap-1">
                            <button onclick="updateStock('${item.id}', -1)" class="bg-white border border-slate-200 rounded py-2 text-indigo-600 hover:bg-red-50 hover:text-red-600 font-bold text-sm shadow-sm transition active:scale-95">-1</button>
                            <button onclick="updateStock('${item.id}', -0.25)" class="bg-white border border-slate-200 rounded py-2 text-indigo-600 hover:bg-red-50 hover:text-red-600 font-bold text-xs shadow-sm transition active:scale-95">-0.25</button>
                            <button onclick="updateStock('${item.id}', 1)" class="bg-white border border-slate-200 rounded py-2 text-indigo-600 hover:bg-indigo-50 font-bold text-sm shadow-sm transition active:scale-95">+1</button>
                        </div>
                    </div>
                `;
                listContainer.appendChild(card);
            });

            // 画面上部のアラートエリア表示
            if (allAlerts.length > 0) {
                alertContainer.classList.remove('hidden');
                alertContainer.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 p-3 rounded shadow-sm">
                        <h4 class="font-bold text-red-700 text-sm mb-1"><i class="fas fa-exclamation-triangle"></i> お知らせ (${allAlerts.length}件)</h4>
                        <ul class="text-sm text-red-600 list-disc list-inside max-h-24 overflow-y-auto">
                            ${allAlerts.map(a => `<li><b>${a.item.name}</b>: ${a.msg}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
        }

        // --- 操作系関数 ---

        function openItemModal(itemId = null) {
            const modal = document.getElementById('itemModal');
            const title = document.getElementById('modalTitle');
            
            // フォームリセット
            document.getElementById('itemId').value = '';
            document.getElementById('itemName').value = '';
            document.getElementById('itemCategory').value = '';
            document.getElementById('itemQuantity').value = 1;
            document.getElementById('itemExpiry').value = '';
            document.getElementById('itemOpenDate').value = '';
            document.querySelector('input[name="zeroAction"][value="keep"]').checked = true;
            document.getElementById('lowStockNotify').checked = false;
            document.getElementById('lowStockThreshold').value = 1;
            document.getElementById('replacementNotify').checked = false;
            document.getElementById('replacementValue').value = 1;
            document.getElementById('replacementUnit').value = 'days';

            // オートコンプリート用のリスト更新
            const uniqueNames = [...new Set(appData.items.map(i => i.name))];
            const datalist = document.getElementById('nameSuggestions');
            datalist.innerHTML = uniqueNames.map(n => `<option value="${n}">`).join('');

            if (itemId) {
                const item = appData.items.find(i => i.id === itemId);
                if (item) {
                    title.innerText = '在庫編集';
                    document.getElementById('itemId').value = item.id;
                    document.getElementById('itemName').value = item.name;
                    document.getElementById('itemCategory').value = item.category;
                    document.getElementById('itemQuantity').value = item.quantity;
                    document.getElementById('itemExpiry').value = item.expiryDate || '';
                    document.getElementById('itemOpenDate').value = item.openDate || '';
                    document.querySelector(`input[name="zeroAction"][value="${item.zeroAction}"]`).checked = true;
                    document.getElementById('lowStockNotify').checked = item.lowStockNotify;
                    document.getElementById('lowStockThreshold').value = item.lowStockThreshold;
                    document.getElementById('replacementNotify').checked = item.replacementNotify;
                    document.getElementById('replacementValue').value = item.replacementValue;
                    document.getElementById('replacementUnit').value = item.replacementUnit;
                }
            } else {
                title.innerText = '在庫登録';
            }
            
            updateFormVisibility();
            modal.classList.remove('hidden');
        }

        function closeItemModal() {
            document.getElementById('itemModal').classList.add('hidden');
        }

        function updateFormVisibility() {
            const lowStock = document.getElementById('lowStockNotify').checked;
            document.getElementById('lowStockConfig').style.display = lowStock ? 'block' : 'none';

            const replace = document.getElementById('replacementNotify').checked;
            document.getElementById('replacementConfig').style.display = replace ? 'block' : 'none';
        }

        function saveItem() {
            const id = document.getElementById('itemId').value;
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('itemCategory').value;
            // 変更: parseFloatで小数を扱えるようにする
            const quantity = parseFloat(document.getElementById('itemQuantity').value);
            const expiryDate = document.getElementById('itemExpiry').value || null;
            
            if (!name || !category) {
                alert('商品名とカテゴリは必須です');
                return;
            }

            // 重複チェック
            // 編集モードでない、または名前が変わった場合にチェック
            const isEdit = !!id;
            let checkDuplicates = true;
            if (isEdit) {
                const original = appData.items.find(i => i.id === id);
                if (original && original.name === name && original.category === category) {
                    checkDuplicates = false; // 名前もカテゴリも変わってないならチェック不要
                }
            }

            if (checkDuplicates) {
                const duplicate = appData.items.find(i => i.name === name && i.id !== id);
                if (duplicate && duplicate.category !== category) {
                    if (!confirm(`既に別のカテゴリ「${duplicate.category}」に「${name}」が登録されています。\n重複登録してもよろしいですか？`)) {
                        return;
                    }
                }
            }

            const itemData = {
                id: id || crypto.randomUUID(),
                name: name,
                category: category,
                quantity: quantity,
                expiryDate: expiryDate,
                openDate: document.getElementById('itemOpenDate').value || null,
                zeroAction: document.querySelector('input[name="zeroAction"]:checked').value,
                lowStockNotify: document.getElementById('lowStockNotify').checked,
                // 変更: parseFloatで小数を扱えるようにする
                lowStockThreshold: parseFloat(document.getElementById('lowStockThreshold').value),
                replacementNotify: document.getElementById('replacementNotify').checked,
                replacementValue: parseInt(document.getElementById('replacementValue').value),
                replacementUnit: document.getElementById('replacementUnit').value
            };

            if (isEdit) {
                const index = appData.items.findIndex(i => i.id === id);
                appData.items[index] = itemData;
            } else {
                appData.items.push(itemData);
            }

            saveData();
            closeItemModal();
            // 新規追加アイテムのカテゴリを表示するようにフィルタ変更（UX向上）
            if (!isEdit && currentFilter !== 'all' && currentFilter !== category) {
                setFilter(category);
            }
        }

        function editItem(id) {
            openItemModal(id);
        }

        function updateStock(id, change) {
            const item = appData.items.find(i => i.id === id);
            if (!item) return;

            // 変更: 浮動小数点の計算誤差を防ぐため、一度整数にして計算する
            let newQuantity = (item.quantity * 100 + change * 100) / 100;

            if (newQuantity < 0) return; // マイナスにはしない

            if (newQuantity === 0) {
                if (change < 0) { // 消費アクションの場合のみ削除ロジック発動
                    if (item.zeroAction === 'delete') {
                        if (confirm(`「${item.name}」をリストから削除しますか？`)) {
                            appData.items = appData.items.filter(i => i.id !== id);
                            saveData();
                            return;
                        }
                    }
                }
            }
            
            item.quantity = newQuantity;
            saveData();
        }

        // --- カテゴリ管理 ---

        function openSettingsModal() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function addCategory() {
            const input = document.getElementById('newCategoryName');
            const val = input.value.trim();
            if (!val) return;
            if (appData.categories.includes(val)) {
                alert('既に存在します');
                return;
            }
            if (appData.categories.length >= 50) {
                alert('カテゴリは最大50個までです');
                return;
            }

            appData.categories.push(val);
            input.value = '';
            saveData();
            renderCategories(); // フィルタと設定リスト更新
        }

        function deleteCategory(cat) {
            if (confirm(`カテゴリ「${cat}」を削除しますか？\n※このカテゴリに属する商品は削除されませんが、表示がおかしくなる可能性があります。`)) {
                appData.categories = appData.categories.filter(c => c !== cat);
                // 属する商品のカテゴリをどうするか？今回はとりあえずそのまま（「未分類」扱い的なロジックが必要だが、仕様簡素化のため削除のみ）
                // 実際の運用では「未分類」に移動させるなどの処理が望ましい
                saveData();
                renderCategories();
            }
        }

        // --- 共有機能（復活の呪文） ---

        function openDataModal() {
            // エクスポート文字列生成
            const json = JSON.stringify(appData);
            // 日本語文字化け対策でBase64エンコード
            const spell = btoa(unescape(encodeURIComponent(json)));
            document.getElementById('exportString').value = spell;
            document.getElementById('importString').value = '';
            document.getElementById('dataModal').classList.remove('hidden');
        }

        function closeDataModal() {
            document.getElementById('dataModal').classList.add('hidden');
        }

        function copyExportString() {
            const input = document.getElementById('exportString');
            
            // テキストを選択（モバイル対応含む）
            input.select();
            input.setSelectionRange(0, 99999); 

            try {
                // 推奨される方法（execCommand）をまず試行
                const successful = document.execCommand('copy');
                
                if (successful) {
                    showToast('クリップボードにコピーしました');
                } else {
                    // フォールバック: Clipboard API
                    // iframe環境では動作しないことが多いが、念のため実装
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                         navigator.clipboard.writeText(input.value)
                            .then(() => showToast('クリップボードにコピーしました'))
                            .catch(err => {
                                console.error('Async: Could not copy text: ', err);
                                showToast('コピーに失敗しました。手動でコピーしてください', true);
                            });
                    } else {
                        showToast('コピーに失敗しました。手動でコピーしてください', true);
                    }
                }
            } catch (err) {
                console.error('Oops, unable to copy', err);
                showToast('コピーに失敗しました。手動でコピーしてください', true);
            }
        }

        // シェア機能（コピーと同時にWeb Share API呼び出し）
        async function shareData() {
            const input = document.getElementById('exportString');
            const text = input.value;
            if (!text) return;

            // 1. まずクリップボードにコピー
            input.select();
            input.setSelectionRange(0, 99999);
            let copied = false;
            try {
                if (document.execCommand('copy')) {
                    copied = true;
                } else if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                    copied = true;
                }
            } catch (e) {
                console.error('Copy failed during share', e);
            }

            // 2. Web Share API 呼び出し
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'SSM在庫データ',
                        text: text
                    });
                    // シェア画面が開くので、トーストは控えめにするか、シェア成功後に表示
                } catch (err) {
                    // ユーザーがキャンセルした場合など
                    console.log('Share canceled or failed', err);
                    if (copied) showToast('クリップボードにコピーしました');
                }
            } else {
                // シェア非対応ブラウザの場合
                if (copied) {
                    showToast('コピーしました（シェア機能非対応ブラウザ）');
                } else {
                    showToast('コピーに失敗しました。手動でコピーしてください', true);
                }
            }
        }

        // トースト通知機能
        function showToast(message, isError = false) {
            // 既存のトーストがあれば削除
            const existingToast = document.getElementById('toast-notification');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.className = `fixed bottom-10 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full text-white font-bold shadow-lg transition-opacity duration-300 z-[100] ${isError ? 'bg-red-500' : 'bg-slate-800'}`;
            toast.textContent = message;
            toast.style.opacity = '0';

            document.body.appendChild(toast);

            // 表示アニメーション
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
            });

            // 自動消去
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function importData() {
            const val = document.getElementById('importString').value.trim();
            if (!val) return;

            try {
                const json = decodeURIComponent(escape(atob(val)));
                const parsed = JSON.parse(json);
                
                if (parsed.categories && Array.isArray(parsed.items)) {
                    if (confirm('現在のデータはすべて上書きされます。よろしいですか？')) {
                        appData = parsed;
                        saveData();
                        location.reload();
                    }
                } else {
                    alert('データの形式が正しくありません');
                }
            } catch (e) {
                alert('呪文が間違っています（デコードエラー）');
                console.error(e);
            }
        }

        // 初期化実行
        init();

    </script>
</body>
</html>